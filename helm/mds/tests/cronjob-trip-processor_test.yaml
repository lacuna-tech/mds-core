suite: test cronjob trip-processor
templates:
  - cronjob.yaml
tests:
  - it: doc 0
    release:
      namespace: mds
    # set:
    #   audience: audience-stub
    #   auth0Domain: auth0Domain-stub
    #   clientId: clientId-stub
    #   googleClientEmail: googleClientEmail-stub
    #   clientSecret: clientSecret-stub
    #   googlePrivateKey: googlePrivateKey-stub
    asserts:
      - isAPIVersion:
          of: batch/v1beta1
        documentIndex: 1
      - isKind:
          of: CronJob
        documentIndex: 1
      - equal:
          path: metadata.name
          value: mds-trip-processor-cron
        documentIndex: 1
      - equal:
          path: metadata.namespace
          value: mds
        documentIndex: 1
      - equal:
          path: spec.schedule
          value: "0 * * * *"
        documentIndex: 1
    # fixme:
    #   - equal:
    #       path: spec.jobTemplate.spec.template.metadata.annotations.sidecar.istio.io/inject
    #       value: "false"
    #     documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.volumes[0].name
          value: mds-config-files
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.volumes[0].configMap.name
          value: mds-config-files
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].name
          value: mds-trip-processor
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].volumeMounts[0].name
          value: mds-config-files
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].volumeMounts[0].mountPath
          value: /mds-config/
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].image
          value: mds-trip-processor:latest
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[0].name
          value: TIMEZONE
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[0].value
          value: America/Los_Angeles
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[1].name
          value: PG_USER
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[1].value
          value: mdsadmin
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[2].name
          value: PG_NAME
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[2].value
          value: mds
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[3].name
          value: PG_PASS
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.name
          value: mds-secrets
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.key
          value: postgresql-password
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[4].name
          value: PG_HOST
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[4].value
          value: mds-postgresql.mds.svc.cluster.local
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[5].name
          value: PG_PORT
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[5].value
          value: "5432"
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[6].name
          value: REDIS_HOST
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[6].value
          value: mds-redis-master.mds.svc.cluster.local
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[7].name
          value: REDIS_PORT
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[7].value
          value: "6379"
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[8].name
          value: TENANT_ID
        documentIndex: 1
      - isEmpty:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[8].value
        documentIndex: 1
      - equal:
          path: spec.jobTemplate.spec.template.spec.restartPolicy
          value: OnFailure
        documentIndex: 1