{{- range $name, $processor := .Values.processors }}
{{- if and $processor.enabled $processor.triggeredBy.cron }}
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: {{ $name }}-cron
  namespace: {{ $.Release.Namespace }}
spec:
  schedule: {{ $processor.triggeredBy.cron | quote }}
  jobTemplate:
    spec:
      template:
        spec:
          volumes:
          - name: mds-config-files
            configMap:
              name: mds-config-files
          containers:
          - name: {{ $name }}
            volumeMounts:
            - name: mds-config-files
              mountPath: /mds-config/
            image: {{ if $.Values.registry }}{{ printf "%s/" $.Values.registry }}{{- end}}{{ $name }}:{{ $processor.version }}
            {{- if $.Values.registry }}
            imagePullPolicy: IfNotPresent
            {{- end }}
            env:
            - name: TIMEZONE
              value: {{ $.Values.timezone }}
            - name: PG_USER
              value: {{ $.Values.postgresql.postgresqlUsername }}
            - name: PG_NAME
              value: {{ $.Values.postgresql.postgresqlDatabase }}
            - name: PG_PASS
              valueFrom:
                secretKeyRef:
                  name: mds-secrets
                  key: postgresql-password
            - name: PG_HOST
            {{- if $.Values.postgresql.internal }}
              value: {{ $.Release.Namespace }}-postgresql.{{ $.Release.Namespace }}.svc.cluster.local
            {{- else }}
              value: {{ $.Values.postgresql.host }}
            {{- end }}
            {{- if $.Values.postgresql.hostReader }}
            - name: PG_HOST_READER
              value: {{ $.Values.postgresql.hostReader }}
            {{- end }}
            {{- if $.Values.postgresql.port }}
            - name: PG_PORT
              value: {{ $.Values.postgresql.port | quote }}
            {{- end}}
            {{- if $processor.migration }}
            - name: PG_MIGRATIONS
              value: {{ $processor.migration | quote }}
            {{- end }}
            - name: REDIS_HOST
            {{- if $.Values.redis.internal }}
              value: {{ $.Release.Namespace }}-redis-master.{{ $.Release.Namespace }}.svc.cluster.local
            {{- else }}
              value: {{ $.Values.redis.host }}
            {{- end }}
            - name: REDIS_PORT
              value: {{ $.Values.redis.port | quote }}
            {{- if not (empty $.Values.tenantId) }}
            - name: TENANT_ID
              value: {{ $.Values.tenantId }}
            {{- end }}
          restartPolicy: OnFailure
---
{{- end}}
{{- end}}
